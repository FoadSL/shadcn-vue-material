# shadcn-vue-material Guide

A complete reference for maintainers, contributors, and anyone working with this repository.

## Table of Contents

1. [Project Overview](#project-overview)
2. [Architecture](#architecture)
3. [TS to JS Conversion Pipeline](#ts-to-js-conversion-pipeline)
4. [Scripts Reference](#scripts-reference)
5. [Workflows](#workflows)
6. [Playground](#playground)
7. [Registry System](#registry-system)
8. [Material Design Integration](#material-design-integration)
9. [Custom Components](#custom-components)
10. [Deployment](#deployment)
11. [Known Limitations](#known-limitations)
12. [Troubleshooting](#troubleshooting)
13. [Best Practices](#best-practices)
14. [References](#references)

---

## Project Overview

This is a **custom shadcn-vue registry** that:

- Serves components in **JavaScript** (not TypeScript) for broader compatibility
- Integrates **Material Design 3** design tokens via the `@vira/material-design-css` package
- Stays **synced with upstream** [shadcn-vue](https://github.com/unovue/shadcn-vue) while allowing custom overrides
- Includes a **Nuxt 4 playground** for previewing and testing components

### Key Differences from Upstream shadcn-vue

| Aspect | Upstream shadcn-vue | This Registry |
|--------|-------------------|---------------|
| Language | TypeScript | JavaScript |
| Design system | Default shadcn theme | Material Design 3 |
| Delivery | TS source | JS-ready JSON via registry API |
| Components | Original | Converted + customized |

---

## Architecture

### Directory Structure

```
shadcn-vue-material/
├── registry/                    # Upstream TS components (synced, DO NOT EDIT)
│   └── new-york-v4/
│       ├── ui/                  # UI components (Button, Dialog, etc.)
│       ├── blocks/              # Complex multi-file examples
│       └── lib/                 # Utilities (utils.ts)
│
├── custom/                      # Converted JS components (safe to edit)
│   └── registry/
│       └── new-york-v4/
│           ├── ui/              # JS versions of UI components
│           ├── blocks/          # JS versions of block examples
│           └── lib/             # JS utilities
│
├── scripts/                     # Build, sync, and conversion scripts
│   ├── transform-ts-to-js.js   # Core TS→JS conversion module
│   ├── convert-source-to-js.js # Batch converts registry/ → custom/registry/
│   ├── detype-vue-sfc.js       # In-place detyping of Vue SFCs
│   ├── build.js                # Builds the public registry JSON
│   ├── sync-from-upstream.js   # Syncs from upstream shadcn-vue
│   └── serve-public.js         # Local dev server for built registry
│
├── packages/                    # Local packages
│   └── material-design-css/     # Material Design 3 CSS library
│
├── public/                      # Built output (deploy this)
│   └── r/
│       └── styles/
│           └── new-york-v4/     # JSON files for each component
│
├── playground/                  # Preview/testing site
│   └── v4/                      # Nuxt 4 app
│       ├── registry/            # Playground's own copy of components
│       ├── scripts/             # Playground build/sync scripts
│       └── nuxt.config.ts
│
├── registry.json                # Root registry manifest
├── components.json              # shadcn-vue CLI config
├── GUIDE.md                     # This file
├── CONTRIBUTING.md              # Contributor guide
├── KNOWN-WARNINGS.md            # Known harmless warnings & solutions
└── package.json
```

### Data Flow

```
upstream shadcn-vue (TS)
        │
        │  pnpm sync
        ▼
    registry/ (TS source, read-only)
        │
        │  pnpm convert:source:js
        ▼
  custom/registry/ (JS components, editable)
        │
        ├──── pnpm build:js ───► public/r/ (deploy)
        │
        └──── pnpm playground:sync ───► playground/v4/registry/ (preview)
```

### Key Principle: One-Way Flow

- `registry/` is **read-only** — overwritten by `pnpm sync`
- `custom/registry/` is **generated** by `pnpm convert:source:js`, then **editable** for customization
- `public/r/` is **build output** — generated by `pnpm build:js`
- `playground/v4/registry/` is a **copy** — generated by `pnpm playground:sync`

---

## TS to JS Conversion Pipeline

The conversion is handled by `scripts/transform-ts-to-js.js`, a custom module that replaces the old `@unovue/detypes` library for more accurate results.

### How It Works

Each Vue SFC goes through four stages:

1. **Macro conversion** (`convertVueMacrosToRuntime`) — Uses Babel AST to convert Vue 3 type-only macros to runtime equivalents:
   - `defineProps<{ foo: string }>()` → `defineProps({ foo: { type: String, required: true } })`
   - `withDefaults(defineProps<Props>(), { ... })` → `defineProps({ ...with defaults... })`
   - `defineEmits<{ ... }>()` → `defineEmits([...names])`
   - `defineSlots<{ ... }>()` → `defineSlots()`

2. **Import cleanup** (`cleanImports`) — Removes `import type` statements and `type` specifiers from mixed imports.

3. **Type stripping** (`stripTypescript`) — Uses TypeScript's `ts.transpileModule` with `verbatimModuleSyntax: true` to strip type annotations while preserving all value imports (critical for Vue template-only imports).

4. **Template cleanup** (`removeTypeAssertionsFromTemplate`) — Removes `as TypeName` assertions and parameter types from `<template>` sections.

### External Type Resolution

The converter can't access types from external packages (like reka-ui). Two mechanisms handle this:

**Known external props** (`KNOWN_EXTERNAL_PROPS` map):
When `defineProps` references an external type like `PrimitiveProps`, the converter checks this map and inlines the known props (`as`, `asChild`). Without this, components using `:as-child="asChild"` in their template would get runtime errors.

**Interface extends resolution**:
When a local interface extends an external type (e.g., `interface Props extends PrimitiveProps { ... }`), the converter resolves the `extends` clause using the same known types map, merging inherited props into the output.

### Extending the Known Types Map

To add support for a new external type, edit `KNOWN_EXTERNAL_PROPS` in `transform-ts-to-js.js`:

```js
const KNOWN_EXTERNAL_PROPS = new Map([
  ['PrimitiveProps', [
    { name: 'as', type: null, optional: true },
    { name: 'asChild', type: 'Boolean', optional: true },
  ]],
  // Add new types here as needed:
  // ['SomeExternalType', [
  //   { name: 'propName', type: 'String', optional: true },
  // ]],
])
```

### What the Pipeline Does NOT Handle

- **External emit types** — `defineEmits<DialogRootEmits>()` becomes `defineEmits()` (no event names). This produces harmless warnings at runtime. See [KNOWN-WARNINGS.md](./KNOWN-WARNINGS.md) for details and solutions.
- **Complex indexed access types** — `Foo['bar']` resolves to `null` (accepts any value).
- **Conditional/mapped types** — Simplified to `Object` or `null`.

---

## Scripts Reference

### Root Scripts (`package.json`)

| Script | Command | Description |
|--------|---------|-------------|
| `build` | `pnpm build` | Build TS registry to `public/r/` |
| `build:js` | `pnpm build:js` | Build JS registry to `public/r/` (recommended) |
| `sync` | `pnpm sync` | Sync upstream TS source into `registry/` |
| `convert:source:js` | `pnpm convert:source:js` | Convert `registry/` → `custom/registry/` (TS→JS) |
| `detype:vue` | `pnpm detype:vue` | In-place detyping of Vue SFCs in `custom/registry/` |
| `serve:public` | `pnpm serve:public` | Serve built registry locally (port 4173) |
| `playground:sync` | `pnpm playground:sync` | Copy custom components to playground + rebuild registry |

### Playground Scripts (`playground/v4/package.json`)

| Script | Command | Description |
|--------|---------|-------------|
| `dev` | `pnpm dev` | Start Nuxt dev server |
| `sync:custom-ui` | `pnpm sync:custom-ui` | Copy `custom/registry/.../ui/` → `playground/v4/registry/.../ui/` |
| `sync:custom-blocks` | `pnpm sync:custom-blocks` | Copy custom blocks into playground |
| `registry:build` | `pnpm registry:build` | Rebuild playground's `__index__.ts` and registry JSON |

### Core Script Files

| File | Purpose |
|------|---------|
| `scripts/transform-ts-to-js.js` | Core conversion module — all TS→JS logic lives here |
| `scripts/convert-source-to-js.js` | Batch runner — walks `registry/`, converts each file, writes to `custom/registry/` |
| `scripts/detype-vue-sfc.js` | In-place converter — strips TS from `.vue` files already in `custom/registry/` |
| `scripts/build.js` | Build script — runs `shadcn-vue build` then optionally converts output to JS |
| `scripts/sync-from-upstream.js` | Sync script — copies upstream `registry/` source |

---

## Workflows

### Full Refresh (after upstream update)

```bash
pnpm sync                    # Pull latest TS source from upstream shadcn-vue
pnpm convert:source:js       # Convert all TS → JS into custom/registry/
pnpm playground:sync         # Copy to playground + rebuild registry index
cd playground/v4 && pnpm dev # Preview in browser
```

### Day-to-Day Development

```bash
# Edit components in custom/registry/
# Then sync to playground:
pnpm playground:sync

# Preview:
cd playground/v4 && pnpm dev
```

### Build for Production

```bash
pnpm build:js                # Build JS registry JSON
pnpm serve:public            # Test locally at http://localhost:4173
# Deploy public/r/ to your static host
```

### Adding a New Custom Component

1. Create component files in `custom/registry/new-york-v4/ui/my-component/`
2. Write components in plain JavaScript (no `lang="ts"`)
3. Create an `index.js` barrel file
4. Add an entry to `registry.json`:
   ```json
   {
     "name": "my-component",
     "type": "registry:ui",
     "dependencies": ["reka-ui"],
     "files": [
       { "path": "custom/registry/new-york-v4/ui/my-component/MyComponent.vue", "type": "registry:ui" },
       { "path": "custom/registry/new-york-v4/ui/my-component/index.js", "type": "registry:ui" }
     ]
   }
   ```
5. Build: `pnpm build:js`

### Overriding an Upstream Component

1. The upstream TS source lives in `registry/new-york-v4/ui/button/`
2. Run `pnpm convert:source:js` (converts all components, including button)
3. Edit the JS version in `custom/registry/new-york-v4/ui/button/`
4. Update `registry.json` to point the `button` item's files to `custom/registry/...`
5. Build: `pnpm build:js`

---

## Playground

The playground is a **Nuxt 4 app** in `playground/v4/` that previews all components.

### How It Works

- Has its own copy of components in `playground/v4/registry/new-york-v4/`
- The `sync:custom-ui` script copies folders from `custom/registry/.../ui/` into the playground, replacing each folder entirely
- The `registry:build` script crawls the playground's registry and generates `__index__.ts` (component index) and `public/r/` (registry JSON)
- Components that aren't in `custom/` stay as the original upstream TS versions — Nuxt handles both JS and TS seamlessly

### Playground Sync Flow

```
custom/registry/.../ui/  ──(sync:custom-ui)──►  playground/v4/registry/.../ui/
                                                          │
                                                  (registry:build)
                                                          │
                                                          ▼
                                                 __index__.ts + public/r/
```

### Important: One-Way Copy

The sync is a one-way copy from `custom/` → `playground/`. **Never edit components directly in `playground/v4/registry/`** — they get overwritten on the next sync.

### Patched Files in Playground

The following files were modified to support JS components alongside the original TS components:

- **`playground/v4/scripts/crawl-content.ts`** — Skips `index.js` barrel files, routes `.js` files through `oxc-parser`, and gracefully handles type resolution failures in Vue SFC compilation
- **`playground/v4/nuxt.config.ts`** — Component auto-import ignores both `*.ts` and `*.js` barrel files

---

## Registry System

### registry.json

The root `registry.json` defines the full component catalog. It contains all upstream shadcn-vue components plus any custom or overridden items.

```json
{
  "name": "my-shadcn-registry",
  "items": [
    {
      "name": "button",
      "type": "registry:ui",
      "files": [
        { "path": "custom/registry/new-york-v4/ui/button/Button.vue", "type": "registry:ui" },
        { "path": "custom/registry/new-york-v4/ui/button/index.js", "type": "registry:ui" }
      ]
    }
  ]
}
```

### Component Types

| Type | Description | Example |
|------|-------------|---------|
| `registry:ui` | UI components | Button, Dialog, Input |
| `registry:block` | Multi-file examples | Dashboard, Login page |
| `registry:lib` | Utility libraries | `lib/utils` |
| `registry:hook` | Composables | useForm, useToast |
| `registry:style` | Style definitions | CSS variables, themes |

### Root vs Playground Registry

These are two separate systems:

- **Root registry** (`registry.json`) — Used by `pnpm build:js` to produce `public/r/`. This is what consumers install from.
- **Playground registry** (`playground/v4/registry/`) — Used by the Nuxt dev server for previewing. Built by `pnpm registry:build` inside `playground/v4/`.

### Consumer Installation

After deploying `public/r/`, consumers add the registry to their `components.json`:

```json
{
  "registries": {
    "@mycompany": "https://your-domain.com/r/styles/new-york-v4/{name}.json"
  }
}
```

Then install components:

```bash
npx shadcn-vue add @mycompany/button
```

---

## Material Design Integration

### Design System Package

`packages/material-design-css/` provides Material Design 3 tokens:

- **Colors**: Surface, primary, secondary, tertiary, error
- **Typography**: Display, headline, title, body, label scales
- **Shape**: Rounded corners (small, medium, large, extra-large)
- **Motion**: Easing curves and duration tokens

### Token System (Three-Tier)

1. **`--md-config-*`** — Project configuration (highest priority)
2. **`--md-sys-*`** — System tokens (resolved from config or defaults)
3. **`--color-*`, `--radius-*`** — Final Tailwind values

### Bridge to shadcn

The playground bridges shadcn semantic variables to MD3 tokens:

```css
:root {
  --background: var(--md-sys-color-surface);
  --foreground: var(--md-sys-color-on-surface);
  --primary: var(--md-sys-color-primary);
  --primary-foreground: var(--md-sys-color-on-primary);
  /* ... */
}
```

This lets shadcn components use Material Design tokens transparently.

---

## Custom Components

### Writing Custom Components

- Write in **plain JavaScript** — no `lang="ts"`, no type annotations
- Use **runtime props** (`defineProps({ ... })`) instead of type-only syntax
- Maintain the same **props, slots, and events** as upstream for compatibility
- Use **Material Design tokens** via Tailwind utilities

### Props from External Types

If your component wraps a reka-ui primitive and needs `as`/`asChild` props, declare them explicitly:

```js
const props = defineProps({
  as: { required: false, default: 'button' },
  asChild: { type: Boolean, required: false },
  // ... your custom props
})
```

The conversion pipeline handles this automatically for converted components (via `KNOWN_EXTERNAL_PROPS`), but manual components should declare these explicitly.

### Documentation Per Component

For each custom or overridden component, consider adding a small `README.md` next to it:

```
custom/registry/new-york-v4/ui/button/
├── Button.vue
├── index.js
└── README.md    # Purpose, what's different, design tokens used
```

---

## Deployment

### Build for Production

```bash
pnpm build:js
# Output: public/r/styles/new-york-v4/*.json
```

### Deploy Options

Deploy the `public/r/` directory to any static host:

- **GitHub Pages** — Push to `gh-pages` branch
- **Netlify / Vercel** — Set build output to `public/r/`
- **Cloudflare Pages** — The playground supports `pnpm deploy` via Wrangler
- **CDN** — Upload `public/r/` to your CDN

### Registry URL Format

```
https://your-domain.com/r/styles/new-york-v4/{component-name}.json
```

---

## Known Limitations

### Emit Type Loss

External emit types (e.g., `DialogRootEmits` from reka-ui) can't be resolved during conversion, resulting in `defineEmits()` with no arguments. This produces harmless "No emitted event found" warnings but does not affect functionality. See [KNOWN-WARNINGS.md](./KNOWN-WARNINGS.md) for details and solution options.

### External Prop Types

Only types listed in `KNOWN_EXTERNAL_PROPS` (currently `PrimitiveProps`) are resolved. Other external prop types (like `DialogRootProps`) fall through — their props go to `$attrs` and are forwarded via `v-bind="$attrs"` or Vue's default attribute inheritance. This works correctly for all current shadcn-vue components.

### Generic Components

Components with `generic="T extends ..."` have their generic attribute removed during conversion. Generic type parameters in props are converted to untyped props (accepting any value).

---

## Troubleshooting

### Build Fails

1. Check `registry.json` syntax (valid JSON)
2. Verify all file paths in `registry.json` exist on disk
3. Run `pnpm sync` then `pnpm convert:source:js` to ensure sources are up to date

### Conversion Produces Incorrect Output

1. Check `scripts/transform-ts-to-js.js` for the relevant conversion logic
2. If a new external type needs resolution, add it to `KNOWN_EXTERNAL_PROPS`
3. Run `pnpm convert:source:js` and inspect the output in `custom/registry/`

### Playground Registry Build Fails

1. Run `pnpm sync:custom-ui` first to ensure components are synced
2. Check `playground/v4/scripts/crawl-content.ts` — it must handle both `.ts` and `.js` files
3. Type resolution errors in blocks are caught and handled gracefully (try-catch in `compileScript`)

### "Property X was accessed during render but is not defined"

A prop from an external type is used in the template but missing from `defineProps`. Add the type to `KNOWN_EXTERNAL_PROPS` in `transform-ts-to-js.js`, then re-run conversion.

### Components Not Appearing in Playground

1. Ensure the component folder exists in `custom/registry/new-york-v4/ui/`
2. Run `pnpm playground:sync` (syncs + rebuilds registry)
3. Check `playground/v4/registry/__index__.ts` for the component entry

---

## Best Practices

### 1. Never Edit `registry/` Directly

Files in `registry/` are overwritten by `pnpm sync`. Always work in `custom/registry/`.

### 2. Keep Component APIs Compatible

When overriding upstream components, maintain the same props, slots, and events. This ensures compatibility with upstream examples and documentation.

### 3. Use Material Design Tokens

Prefer MD3 utilities over hardcoded values:
- `bg-primary` (MD3 token)
- `text-on-primary` (MD3 token)
- Not `bg-blue-500` (hardcoded)

### 4. Test After Sync

Always rebuild and test after syncing from upstream:

```bash
pnpm sync
pnpm convert:source:js
pnpm playground:sync
cd playground/v4 && pnpm dev
```

### 5. Document Custom Components

For each custom component, maintain:
- A per-component `README.md` explaining what's different and why
- An in-code comment at the top of the main Vue file
- An entry in the custom-items tracking list (if you maintain one)

### 6. Keep Dependencies Updated

Regularly update:
- `shadcn-vue` (via `pnpm sync`)
- `reka-ui` and other runtime deps
- Babel and TypeScript packages used by the conversion pipeline

---

## References

- [shadcn-vue documentation](https://www.shadcn-vue.com/docs/registry)
- [shadcn-vue GitHub](https://github.com/unovue/shadcn-vue)
- [Registry JSON schema](https://shadcn-vue.com/schema/registry.json)
- [Registry item schema](https://shadcn-vue.com/schema/registry-item.json)
- [Material Design 3](https://m3.material.io/)
- [reka-ui (headless components)](https://reka-ui.com/)
- [TailwindCSS v4](https://tailwindcss.com/docs)
